trigger:
  branches:
    include:
      - main

variables:
  imageName: 'valberxz21/fcg-api'
  imageTag: '$(Build.BuildId)'
  azureSubscription: 'FCGConnection'
  webAppName: 'fcg49app'
  resourceGroup: 'FCG'

stages:

# --------------------------
- stage: Build
  displayName: 'ğŸ³ Build da Imagem Docker'
  jobs:
    - job: BuildImage
      steps:
        - task: DockerInstaller@0
          inputs:
            dockerVersion: 'latest'

        - script: |
            echo "ğŸ”¨ Buildando imagem Docker com tag $(imageTag)"
            docker build --no-cache -f src/FCG.API/Dockerfile \
              -t $(imageName):$(imageTag) \
              -t $(imageName):latest .
          displayName: 'Build Docker Image'

# --------------------------
- stage: Push
  displayName: 'ğŸ“¤ Push para Docker Hub'
  dependsOn: Build
  jobs:
    - job: PushImage
      steps:
        - task: Docker@2
          displayName: 'Login no Docker Hub'
          inputs:
            command: login
            containerRegistry: 'DockerHub-Valber'

        - task: Docker@2
          displayName: 'Push Docker image para Docker Hub'
          inputs:
            command: push
            tags: |
              $(imageName):$(imageTag)
              $(imageName):latest

# --------------------------
- stage: Inspect
  displayName: 'ğŸ” Inspecionar Imagem Publicada'
  dependsOn: Push
  jobs:
    - job: InspectImage
      steps:
        - script: |
            echo "ğŸ•µï¸ Baixando imagem para inspeÃ§Ã£o..."
            docker pull $(imageName):$(imageTag)
            docker inspect $(imageName):$(imageTag) --format='Imagem: {{.RepoTags}} | SHA: {{.Id}}'
          displayName: 'Verificar digest da imagem'

# --------------------------
- stage: Deploy
  displayName: 'ğŸš€ Deploy para Azure WebApp'
  dependsOn: Inspect
  jobs:
    - job: DeployWebApp
      steps:
        - task: AzureWebAppContainer@1
          displayName: 'Deploy container image'
          inputs:
            azureSubscription: '$(azureSubscription)'
            appName: '$(webAppName)'
            containers: '$(imageName):$(imageTag)'

# --------------------------
- stage: Verify
  displayName: 'ğŸ§ª VerificaÃ§Ã£o do Deploy'
  dependsOn: Deploy
  jobs:
    - job: VerifyDeployedImage
      steps:
        - task: AzureCLI@2
          displayName: 'Verificar imagem rodando na WebApp'
          inputs:
            azureSubscription: '$(azureSubscription)'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              echo "âœ… Verificando imagem publicada no Azure Web App..."
              currentImage=$(az webapp config container show \
                --name $(webAppName) \
                --resource-group $(resourceGroup) \
                --query containers[0].image -o tsv)

              echo "ğŸ“¦ Imagem atual na WebApp: $currentImage"
              echo "ğŸ¯ Imagem esperada: $(imageName):$(imageTag)"

              if [ "$currentImage" == "$(imageName):$(imageTag)" ]; then
                echo "âœ… Imagem correta estÃ¡ rodando."
              else
                echo "âŒ A WebApp estÃ¡ com uma imagem diferente!"
                exit 1
              fi
